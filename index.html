<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Branch Profitability Audit</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=DM+Sans:wght@300;400;500&display=swap');

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #f4f6f9;
  --white: #ffffff;
  --border: #e8ecf1;
  --text: #1a2035;
  --text2: #6b7a99;
  --text3: #9ba5bb;
  --green: #2ecc8f;
  --red: #e84c4c;
  --blue: #4a90e2;
  --orange: #f0a830;
  --profit-green: #1db87a;
  --shadow: 0 2px 12px rgba(0,0,0,0.07);
  --shadow-lg: 0 4px 24px rgba(0,0,0,0.1);
  --radius: 14px;
}

body {
  font-family: 'Plus Jakarta Sans', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
}

/* ‚îÄ‚îÄ Top Header ‚îÄ‚îÄ */
.page-header {
  background: var(--white);
  padding: 20px 32px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 16px;
}

.page-title h1 {
  font-size: 22px;
  font-weight: 800;
  color: var(--text);
  letter-spacing: -0.3px;
}
.page-title p {
  font-size: 12.5px;
  color: var(--blue);
  font-weight: 500;
  margin-top: 2px;
}

.header-controls {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

.search-wrap {
  position: relative;
  display: flex;
  align-items: center;
}
.search-wrap svg {
  position: absolute;
  left: 11px;
  color: var(--text3);
  pointer-events: none;
}
.search-input {
  padding: 8px 14px 8px 34px;
  border: 1px solid var(--border);
  border-radius: 8px;
  font-family: inherit;
  font-size: 13px;
  color: var(--text);
  background: var(--white);
  outline: none;
  width: 190px;
  transition: border-color 0.2s;
}
.search-input:focus { border-color: var(--blue); }
.search-input::placeholder { color: var(--text3); }

.filter-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px 14px;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: var(--white);
  font-family: inherit;
  font-size: 13px;
  font-weight: 500;
  color: var(--text);
  cursor: pointer;
  transition: border-color 0.2s, box-shadow 0.2s;
}
.filter-btn:hover { border-color: #c0c8d8; box-shadow: var(--shadow); }
.filter-btn select {
  border: none;
  background: transparent;
  font-family: inherit;
  font-size: 13px;
  font-weight: 500;
  color: var(--text);
  cursor: pointer;
  outline: none;
  padding: 0;
}

.upload-label {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px 16px;
  border: 1.5px solid var(--blue);
  border-radius: 8px;
  background: var(--white);
  font-family: inherit;
  font-size: 13px;
  font-weight: 600;
  color: var(--blue);
  cursor: pointer;
  transition: background 0.2s;
  position: relative;
}
.upload-label:hover { background: #f0f5ff; }
.upload-label input { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; }

.upload-info {
  font-size: 11.5px;
  color: var(--text3);
  max-width: 160px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.upload-error { font-size: 11.5px; color: var(--red); }

/* ‚îÄ‚îÄ Main Layout ‚îÄ‚îÄ */
.main { padding: 28px 32px; }

/* ‚îÄ‚îÄ KPI Cards ‚îÄ‚îÄ */
.kpi-row {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 16px;
  margin-bottom: 24px;
}
@media(max-width:900px){ .kpi-row{grid-template-columns:repeat(2,1fr);} }
@media(max-width:500px){ .kpi-row{grid-template-columns:1fr;} }

.kpi-card {
  background: var(--white);
  border-radius: var(--radius);
  padding: 22px 24px;
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
  position: relative;
  transition: box-shadow 0.2s;
}
.kpi-card:hover { box-shadow: var(--shadow-lg); }
.kpi-card.profit { border-top: 3px solid var(--green); }

.kpi-top {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 14px;
}
.kpi-icon {
  width: 36px; height: 36px;
  border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-size: 16px;
}
.kpi-icon.blue { background: #eef3ff; }
.kpi-icon.red { background: #fff0f0; }
.kpi-icon.purple { background: #f3eeff; }
.kpi-icon.green { background: #edfbf5; }

.deduction-badge {
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 0.06em;
  color: var(--red);
  background: #fff0f0;
  border: 1px solid #ffd5d5;
  border-radius: 4px;
  padding: 2px 7px;
  text-transform: uppercase;
}

.kpi-label {
  font-size: 10.5px;
  font-weight: 700;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--text2);
  margin-bottom: 6px;
}
.kpi-value {
  font-size: 28px;
  font-weight: 800;
  color: var(--text);
  letter-spacing: -0.5px;
}
.kpi-card.profit .kpi-value { color: var(--profit-green); }

/* ‚îÄ‚îÄ Bottom row ‚îÄ‚îÄ */
.bottom-row {
  display: grid;
  grid-template-columns: 1fr 340px;
  gap: 16px;
}
@media(max-width:1100px){ .bottom-row{grid-template-columns:1fr;} }

.chart-card {
  background: var(--white);
  border-radius: var(--radius);
  padding: 24px;
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
}

.chart-card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 24px;
}
.chart-card-title {
  font-size: 11px;
  font-weight: 800;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--text2);
}
.chart-view-label {
  font-size: 12px;
  color: var(--text3);
  font-weight: 500;
}

.chart-wrap { position: relative; height: 280px; }

/* ‚îÄ‚îÄ Donut ‚îÄ‚îÄ */
.donut-wrap { position: relative; display: flex; align-items: center; justify-content: center; }

/* ‚îÄ‚îÄ Legend ‚îÄ‚îÄ */
.legend {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 20px;
  margin-top: 14px;
  flex-wrap: wrap;
}
.legend-item { display: flex; align-items: center; gap: 6px; font-size: 12px; font-weight: 500; color: var(--text2); }
.legend-dot { width: 11px; height: 11px; border-radius: 3px; }

/* ‚îÄ‚îÄ Empty / Placeholder ‚îÄ‚îÄ */
.empty-overlay {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 200px;
  color: var(--text3);
  font-size: 13px;
  gap: 8px;
}
.empty-overlay span { font-size: 28px; }

/* ‚îÄ‚îÄ Client Detail Table ‚îÄ‚îÄ */
.table-card {
  background: var(--white);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
  overflow: hidden;
}
.client-table {
  width: 100%;
  border-collapse: collapse;
}
.client-table thead th {
  font-size: 10.5px;
  font-weight: 700;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--text3);
  padding: 12px 20px;
  text-align: left;
  border-bottom: 1px solid var(--border);
  background: #fafbfd;
  white-space: nowrap;
}
.client-table tbody tr {
  border-bottom: 1px solid var(--border);
  transition: background 0.15s;
}
.client-table tbody tr:last-child { border-bottom: none; }
.client-table tbody tr:hover { background: #f9fbff; }
.client-table tbody td {
  padding: 10px 20px;
  font-size: 13px;
  vertical-align: middle;
}
.td-client-name {
  font-weight: 700;
  color: var(--text);
  font-size: 13.5px;
  display: flex;
  align-items: center;
  gap: 6px;
}
.td-client-name .trend-icon { font-size: 11px; color: var(--text3); }
.td-owner {
  font-size: 11.5px;
  color: var(--text3);
  margin-top: 1px;
}
.td-margin { font-size: 13.5px; font-weight: 600; color: var(--text); }
.td-margin-hr {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 6px;
  font-size: 12.5px;
  font-weight: 600;
  color: var(--text);
}
.td-margin-hr.high   { background: #e8faf3; color: #1a9e6a; }
.td-margin-hr.mid    { background: #fef9e8; color: #b07d00; }
.td-margin-hr.low    { background: #fff3e8; color: #c05a00; }
.td-erosion { font-size: 13px; font-weight: 600; color: var(--red); }
.td-erosion.zero { color: var(--text3); }
.trend-badge {
  display: inline-flex; align-items: center; gap: 4px;
  font-size: 12px; font-weight: 600;
  padding: 3px 10px; border-radius: 5px;
}
.trend-badge.drop { color: #c0392b; background: #fff0f0; }
.trend-badge.up   { color: #1a9e6a; background: #eafaf3; }
.hidden { display: none !important; }
.fade { animation: fadeUp 0.35s ease both; }
@keyframes fadeUp { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:none} }
</style>
</head>
<body>

<!-- ‚îÄ‚îÄ Page Header ‚îÄ‚îÄ -->
<div class="page-header">
  <div class="page-title">
    <h1>Branch Profitability Audit</h1>
    <p>Net Margin Tracking (Holiday / SSP / SMP / SPP / PENS / Internal)</p>
  </div>

  <div class="header-controls">
    <span class="upload-info" id="uploadName"></span>
    <span class="upload-error" id="uploadError"></span>

    <!-- Search -->
    <div class="search-wrap">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      <input type="text" class="search-input" id="searchInput" placeholder="Find client‚Ä¶"/>
    </div>

    <!-- Period filter -->
    <div class="filter-btn">
      üìÖ
      <select id="filterPeriod"><option value="All">Weekly</option></select>
    </div>

    <!-- Month filter -->
    <div class="filter-btn">
      <select id="filterMonth"><option value="All">All Months</option></select>
    </div>

    <!-- Recruiter filter -->
    <div class="filter-btn">
      <select id="filterConsultant"><option value="All">All Recruiter</option></select>
    </div>

    <!-- Upload -->
    <label class="upload-label">
      ‚Üë Upload CSV
      <input type="file" accept=".csv" id="csvInput"/>
    </label>
  </div>
</div>

<!-- ‚îÄ‚îÄ Main Content ‚îÄ‚îÄ -->
<div class="main">

  <!-- KPI Cards -->
  <div class="kpi-row">
    <div class="kpi-card fade">
      <div class="kpi-top">
        <div class="kpi-icon blue">üí≤</div>
      </div>
      <div class="kpi-label">Gross Margin</div>
      <div class="kpi-value" id="kpiGross">¬£0.00</div>
    </div>

    <div class="kpi-card fade" style="animation-delay:0.05s">
      <div class="kpi-top">
        <div class="kpi-icon red">ü´Ä</div>
        <span class="deduction-badge">Deduction</span>
      </div>
      <div class="kpi-label">SSP Liability</div>
      <div class="kpi-value" id="kpiSSP">¬£0.00</div>
    </div>

    <div class="kpi-card fade" style="animation-delay:0.1s">
      <div class="kpi-top">
        <div class="kpi-icon purple">üòä</div>
        <span class="deduction-badge">Deduction</span>
      </div>
      <div class="kpi-label">SMP Liability</div>
      <div class="kpi-value" id="kpiSMP">¬£0.00</div>
    </div>

    <div class="kpi-card profit fade" style="animation-delay:0.15s">
      <div class="kpi-top">
        <div class="kpi-icon green">‚Üó</div>
      </div>
      <div class="kpi-label">Net Branch Profit</div>
      <div class="kpi-value" id="kpiNet">¬£0.00</div>
    </div>
  </div>

  <!-- Bottom row: Bar chart + Donut -->
  <div class="bottom-row">

    <!-- Left: Weekly Margin Trend -->
    <div class="chart-card fade" style="animation-delay:0.2s">
      <div class="chart-card-header">
        <div class="chart-card-title">Weekly Margin Trend (Top 5 Active)</div>
        <div class="chart-view-label" id="viewLabel">View: Weekly</div>
      </div>
      <div id="barEmpty" class="empty-overlay">
        <span>üìä</span>Upload a CSV to see account data
      </div>
      <div id="barChartWrap" class="chart-wrap hidden" style="height:300px">
        <canvas id="chartBar"></canvas>
      </div>
    </div>

    <!-- Right: Consultant Share donut -->
    <div class="chart-card fade" style="animation-delay:0.25s">
      <div class="chart-card-header">
        <div class="chart-card-title">Consultant Share</div>
      </div>
      <div id="donutEmpty" class="empty-overlay">
        <span>üç©</span>No data yet
      </div>
      <div id="donutWrap" class="hidden">
        <div class="donut-wrap" style="height:240px"><canvas id="chartDonut"></canvas></div>
      </div>
    </div>

  </div>

  <!-- Costs Chart Row -->
  <div style="display:grid;grid-template-columns:1fr 340px;gap:16px;margin-top:16px;">

    <!-- Left: Cost by Client stacked bar -->
    <div class="chart-card fade" style="animation-delay:0.28s;">
      <div class="chart-card-header">
        <div class="chart-card-title">Cost Breakdown by Client</div>
        <div class="chart-view-label">SSP + SMP + Holiday + Pension + Other</div>
      </div>
      <div id="costsEmpty" class="empty-overlay">
        <span>üí∏</span>Upload a CSV to see cost breakdown
      </div>
      <div id="costsChartWrap" class="hidden" style="position:relative;height:260px;">
        <canvas id="chartCosts"></canvas>
      </div>
    </div>

    <!-- Right: Cost by Consultant donut -->
    <div class="chart-card fade" style="animation-delay:0.32s;">
      <div class="chart-card-header">
        <div class="chart-card-title">Cost by Consultant</div>
      </div>
      <div id="costConsultantEmpty" class="empty-overlay">
        <span>üë§</span>No data yet
      </div>
      <div id="costConsultantWrap" class="hidden">
        <div style="position:relative;height:200px;"><canvas id="chartCostConsultant"></canvas></div>
        <div id="costConsultantLegend" style="margin-top:14px;"></div>
      </div>
    </div>

  </div>

  <!-- Client Detail Table -->
  <div class="table-card fade" style="animation-delay:0.3s; margin-top:16px;">
    <div id="tableEmpty" class="empty-overlay">
      <span>üìã</span>Upload a CSV to see client breakdown
    </div>
    <div id="tableWrap" class="hidden">
      <table class="client-table">
        <thead>
          <tr>
            <th>Client / Owner</th>
            <th>Total Margin</th>
            <th>Margin/Hr</th>
            <th>Costs</th>
            <th>Trend</th>
          </tr>
        </thead>
        <tbody id="clientTableBody"></tbody>
      </table>
    </div>
  </div>

</div>

<script>
// ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let sourceRows = [];
let barChart, donutChart;

// ‚îÄ‚îÄ CSV Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const getCI = (obj, ...names) => {
  const keys = Object.keys(obj || {});
  for (const name of names) {
    const target = String(name).toLowerCase();
    const k = keys.find(x => x.toLowerCase() === target);
    if (k !== undefined) return obj[k];
  }
  return "";
};
const parseWeek = x => { const m = String(x ?? '').trim().match(/(\d+)/); return m ? Number(m[1]) || 0 : 0; };
const toNum = x => { const n = Number(String(x ?? '').replace(/[¬£,]/g, '').trim()); return Number.isFinite(n) ? n : 0; };
const fmtGBP = n => '¬£' + Math.abs(n).toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

// ‚îÄ‚îÄ CSV Upload ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('csvInput').addEventListener('change', e => {
  const file = e.target.files?.[0];
  if (!file) return;
  setError('');
  document.getElementById('uploadName').textContent = file.name;

  Papa.parse(file, {
    header: true, skipEmptyLines: true,
    complete: ({ errors, data }) => {
      if (errors?.length) { setError(errors[0].message || 'CSV parse error'); return; }

      const rows = (Array.isArray(data) ? data : []).map(r => ({
        client:      String(getCI(r, 'client')).trim(),
        consultant:  String(getCI(r, 'consultant') || 'Unknown').trim() || 'Unknown',
        newClient:   String(getCI(r, 'new_client', 'new client') || 'No').trim() || 'No',
        metric:      String(getCI(r, 'metric')).trim(),
        value:       toNum(getCI(r, 'value')),
        week:        parseWeek(getCI(r, 'week', 'week_label', 'week label')),
        month:       Number(getCI(r, 'month_num', 'month')) || 0,
      })).filter(x => x.client && x.metric);

      if (!rows.length) {
        setError('No usable rows. Expected: Client, Consultant, Metric, Value, Week, Month_Num');
        return;
      }
      sourceRows = rows;
      initFilters();
      render();
    }
  });
  e.target.value = '';
});

function setError(msg) { document.getElementById('uploadError').textContent = msg; }

// ‚îÄ‚îÄ Filters ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initFilters() {
  const consultants = [...new Set(sourceRows.map(r => r.consultant))].sort();
  const months = [...new Set(sourceRows.map(r => r.month).filter(Boolean))].sort((a,b)=>a-b);
  const weeks  = [...new Set(sourceRows.map(r => r.week).filter(Boolean))].sort((a,b)=>a-b);

  // Consultant
  const cs = document.getElementById('filterConsultant');
  cs.innerHTML = '<option value="All">All Recruiter</option>';
  consultants.forEach(c => { const o = document.createElement('option'); o.value=c; o.textContent=c; cs.appendChild(o); });

  // Month
  const ms = document.getElementById('filterMonth');
  ms.innerHTML = '<option value="All">All Months</option>';
  months.forEach(m => { const o = document.createElement('option'); o.value=m; o.textContent=`Month ${m}`; ms.appendChild(o); });

  // Period
  const ps = document.getElementById('filterPeriod');
  ps.innerHTML = '<option value="All">Weekly</option>';
  weeks.forEach(w => { const o = document.createElement('option'); o.value=w; o.textContent=`Week ${w}`; ps.appendChild(o); });

  ['filterConsultant','filterMonth','filterPeriod','searchInput'].forEach(id => {
    const el = document.getElementById(id);
    el.addEventListener('change', render);
    el.addEventListener('input', render);
  });
}

function getFiltered() {
  const consultant = document.getElementById('filterConsultant')?.value || 'All';
  const month      = document.getElementById('filterMonth')?.value || 'All';
  const period     = document.getElementById('filterPeriod')?.value || 'All';
  const search     = (document.getElementById('searchInput')?.value || '').toLowerCase();
  return sourceRows.filter(r =>
    (consultant === 'All' || r.consultant === consultant) &&
    (month === 'All'      || String(r.month) === String(month)) &&
    (period === 'All'     || String(r.week)  === String(period)) &&
    (!search || r.client.toLowerCase().includes(search))
  );
}

// ‚îÄ‚îÄ Render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function render() {
  const rows = getFiltered();
  renderKPIs(rows);
  renderBarChart(rows);
  renderDonut(rows);
  renderCostsChart(rows);
  renderCostConsultantChart(rows);
  renderTable(rows);

  const period = document.getElementById('filterPeriod')?.value;
  document.getElementById('viewLabel').textContent = period && period !== 'All' ? `View: Week ${period}` : 'View: Weekly';
}

// KPIs ‚Äî map metrics by name
function sumMetric(rows, ...names) {
  return rows
    .filter(r => names.some(n => r.metric.toLowerCase().includes(n.toLowerCase())))
    .reduce((s, r) => s + r.value, 0);
}

function renderKPIs(rows) {
  const gross   = sumMetric(rows, 'gross', 'margin');
  const ssp     = sumMetric(rows, 'ssp');
  const smp     = sumMetric(rows, 'smp');
  // If no metric matches, fall back to total
  const total   = rows.reduce((s,r) => s + r.value, 0);
  const grossV  = gross  || total;
  const sspV    = ssp;
  const smpV    = smp;
  const netV    = grossV - sspV - smpV;

  document.getElementById('kpiGross').textContent = fmtGBP(grossV);
  document.getElementById('kpiSSP').textContent   = fmtGBP(sspV);
  document.getElementById('kpiSMP').textContent   = fmtGBP(smpV);
  document.getElementById('kpiNet').textContent   = fmtGBP(netV);
}

function renderBarChart(rows) {
  if (!rows.length) {
    document.getElementById('barEmpty').classList.remove('hidden');
    document.getElementById('barChartWrap').classList.add('hidden');
    return;
  }

  // Top 5 clients by total positive value
  const clientTotals = {};
  rows.forEach(r => { if (r.value > 0) clientTotals[r.client] = (clientTotals[r.client] || 0) + r.value; });
  const top5 = Object.entries(clientTotals).sort((a,b) => b[1]-a[1]).slice(0,5).map(x=>x[0]);

  // All weeks sorted
  const weeks = [...new Set(rows.map(r=>r.week).filter(Boolean))].sort((a,b)=>a-b);

  // For each week, sum value per top-5 client
  const WEEK_COLORS = ['#5b8dee','#7aa8f5','#9dc3f7','#bcd6f9','#d9ebfc'];

  const datasets = weeks.map((w, i) => ({
    label: `Week ${w}`,
    data: top5.map(client =>
      rows.filter(r => r.client === client && r.week === w && r.value > 0)
          .reduce((s,r) => s + r.value, 0)
    ),
    backgroundColor: WEEK_COLORS[i % WEEK_COLORS.length],
    borderRadius: 3,
    borderSkipped: false,
  }));

  document.getElementById('barEmpty').classList.add('hidden');
  document.getElementById('barChartWrap').classList.remove('hidden');

  if (barChart) barChart.destroy();
  barChart = new Chart(document.getElementById('chartBar').getContext('2d'), {
    type: 'bar',
    data: { labels: top5, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: true,
          position: 'top',
          align: 'end',
          labels: {
            color: '#6b7a99',
            font: { family:'Plus Jakarta Sans', size:11 },
            boxWidth: 10, boxHeight: 10, borderRadius: 3, padding: 12,
          }
        },
        tooltip: {
          backgroundColor: '#fff',
          borderColor: '#e8ecf1',
          borderWidth: 1,
          titleColor: '#6b7a99',
          bodyColor: '#1a2035',
          titleFont: { family:'Plus Jakarta Sans', size:11 },
          bodyFont: { family:'Plus Jakarta Sans', size:12, weight:'600' },
          callbacks: { label: ctx => ` ¬£${ctx.parsed.y.toLocaleString('en-GB',{minimumFractionDigits:2})}` }
        }
      },
      scales: {
        x: {
          grid: { display: false },
          ticks: { color: '#6b7a99', font: { family:'Plus Jakarta Sans', size:11 }, maxRotation: 15 },
          border: { color: '#e8ecf1' },
        },
        y: {
          grid: { color: '#f0f2f5' },
          ticks: { color: '#9ba5bb', font: { family:'Plus Jakarta Sans', size:11 },
            callback: v => Number(v).toLocaleString() },
          border: { color: '#e8ecf1' },
        }
      }
    }
  });
}

function renderDonut(rows) {
  if (!rows.length) {
    document.getElementById('donutEmpty').classList.remove('hidden');
    document.getElementById('donutWrap').classList.add('hidden');
    return;
  }

  // Sum positive value by consultant
  const consultantMap = {};
  rows.forEach(r => {
    if (r.value > 0) consultantMap[r.consultant] = (consultantMap[r.consultant] || 0) + r.value;
  });

  const segments = Object.entries(consultantMap).sort((a,b) => b[1]-a[1]);

  document.getElementById('donutEmpty').classList.add('hidden');
  document.getElementById('donutWrap').classList.remove('hidden');

  const DONUT_COLORS = ['#4a90e2','#2ecc8f','#f0a830','#e84c4c','#22d3ee','#a855f7','#fb923c','#34d399'];

  if (donutChart) donutChart.destroy();

  const labels = segments.length ? segments.map(x=>x[0]) : ['No Data'];
  const values = segments.length ? segments.map(x=>x[1]) : [1];
  const colors = segments.length ? DONUT_COLORS.slice(0,segments.length) : ['#e8ecf1'];

  donutChart = new Chart(document.getElementById('chartDonut').getContext('2d'), {
    type: 'doughnut',
    data: {
      labels,
      datasets: [{
        data: values,
        backgroundColor: colors,
        borderWidth: 3,
        borderColor: '#fff',
        hoverBorderWidth: 3,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '65%',
      plugins: {
        legend: {
          display: true,
          position: 'right',
          labels: {
            color: '#6b7a99',
            font: { family:'Plus Jakarta Sans', size:12 },
            boxWidth: 10, boxHeight: 10, borderRadius: 3, padding: 12,
            generateLabels: chart => chart.data.labels.map((label, i) => ({
              text: label,
              fillStyle: chart.data.datasets[0].backgroundColor[i],
              strokeStyle: '#fff',
              lineWidth: 2,
              index: i,
            }))
          }
        },
        tooltip: {
          backgroundColor: '#fff',
          borderColor: '#e8ecf1',
          borderWidth: 1,
          titleColor: '#6b7a99',
          bodyColor: '#1a2035',
          callbacks: {
            label: ctx => {
              const total = ctx.dataset.data.reduce((a,b)=>a+b,0);
              const pct = total > 0 ? ((ctx.parsed/total)*100).toFixed(1) : 0;
              return ` ¬£${ctx.parsed.toLocaleString('en-GB',{minimumFractionDigits:2})} (${pct}%)`;
            }
          }
        }
      }
    }
  });
}

let costsChart, costConsultantChart;

function renderCostsChart(rows) {
  if (!rows.length) {
    document.getElementById('costsEmpty').classList.remove('hidden');
    document.getElementById('costsChartWrap').classList.add('hidden');
    return;
  }

  // Identify cost rows: negative values or known cost metric names
  const COST_KEYWORDS = ['holiday','ssp','smp','pension','pens','spp','internal','erosion','leakage','cost','deduction'];
  const costRows = rows.filter(r =>
    r.value < 0 || COST_KEYWORDS.some(k => r.metric.toLowerCase().includes(k))
  );

  if (!costRows.length) {
    document.getElementById('costsEmpty').classList.remove('hidden');
    document.getElementById('costsChartWrap').classList.add('hidden');
    return;
  }

  // Group costs by metric type, stacked per client (top 8 by total cost)
  const clientCosts = {};
  costRows.forEach(r => {
    if (!clientCosts[r.client]) clientCosts[r.client] = {};
    clientCosts[r.client][r.metric] = (clientCosts[r.client][r.metric] || 0) + Math.abs(r.value);
  });

  const top8 = Object.entries(clientCosts)
    .map(([c, m]) => [c, Object.values(m).reduce((s,v)=>s+v,0)])
    .sort((a,b)=>b[1]-a[1]).slice(0,8).map(x=>x[0]);

  const allMetrics = [...new Set(costRows.map(r=>r.metric))];
  const COST_COLORS = ['#e84c4c','#f0a830','#4a90e2','#a855f7','#2ecc8f','#22d3ee','#fb923c','#f472b6'];

  const datasets = allMetrics.map((metric, i) => ({
    label: metric,
    data: top8.map(client => clientCosts[client]?.[metric] || 0),
    backgroundColor: COST_COLORS[i % COST_COLORS.length],
    borderRadius: 3,
    borderSkipped: false,
    stack: 'costs',
  }));

  document.getElementById('costsEmpty').classList.add('hidden');
  document.getElementById('costsChartWrap').classList.remove('hidden');

  if (costsChart) costsChart.destroy();
  costsChart = new Chart(document.getElementById('chartCosts').getContext('2d'), {
    type: 'bar',
    data: { labels: top8, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: true, position: 'top', align: 'end',
          labels: {
            color: '#6b7a99', font: { family:'Plus Jakarta Sans', size:11 },
            boxWidth: 10, boxHeight: 10, borderRadius: 3, padding: 12,
          }
        },
        tooltip: {
          backgroundColor: '#fff', borderColor: '#e8ecf1', borderWidth: 1,
          titleColor: '#6b7a99', bodyColor: '#1a2035',
          titleFont: { family:'Plus Jakarta Sans', size:11 },
          bodyFont: { family:'Plus Jakarta Sans', size:12, weight:'600' },
          callbacks: { label: ctx => ` ${ctx.dataset.label}: ¬£${ctx.parsed.y.toLocaleString('en-GB',{minimumFractionDigits:2})}` }
        }
      },
      scales: {
        x: {
          stacked: true,
          grid: { display: false },
          ticks: { color: '#6b7a99', font: { family:'Plus Jakarta Sans', size:11 }, maxRotation: 20 },
          border: { color: '#e8ecf1' },
        },
        y: {
          stacked: true,
          grid: { color: '#f0f2f5' },
          ticks: { color: '#9ba5bb', font: { family:'Plus Jakarta Sans', size:11 },
            callback: v => '¬£' + Number(v).toLocaleString() },
          border: { color: '#e8ecf1' },
        }
      }
    }
  });
}

function renderCostConsultantChart(rows) {
  const show = v => {
    document.getElementById('costConsultantEmpty').classList.toggle('hidden', v);
    document.getElementById('costConsultantWrap').classList.toggle('hidden', !v);
  };

  const COST_KEYWORDS = ['holiday','ssp','smp','pension','pens','spp','internal','erosion','leakage','cost','deduction'];
  const costRows = rows.filter(r =>
    r.value < 0 || COST_KEYWORDS.some(k => r.metric.toLowerCase().includes(k))
  );

  if (!costRows.length) { show(false); return; }
  show(true);

  // Sum costs per consultant
  const consultantCosts = {};
  costRows.forEach(r => {
    consultantCosts[r.consultant] = (consultantCosts[r.consultant] || 0) + Math.abs(r.value);
  });

  const sorted = Object.entries(consultantCosts).sort((a,b) => b[1]-a[1]);
  const labels = sorted.map(x => x[0]);
  const values = sorted.map(x => x[1]);
  const COLORS = ['#4a90e2','#2ecc8f','#f0a830','#e84c4c','#a855f7','#22d3ee','#fb923c','#34d399'];
  const colors = COLORS.slice(0, labels.length);

  const total = values.reduce((s,v)=>s+v,0);

  if (costConsultantChart) costConsultantChart.destroy();
  costConsultantChart = new Chart(document.getElementById('chartCostConsultant').getContext('2d'), {
    type: 'doughnut',
    data: {
      labels,
      datasets: [{
        data: values,
        backgroundColor: colors,
        borderWidth: 3,
        borderColor: '#fff',
        hoverBorderWidth: 3,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '65%',
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#fff', borderColor: '#e8ecf1', borderWidth: 1,
          titleColor: '#6b7a99', bodyColor: '#1a2035',
          callbacks: {
            label: ctx => {
              const pct = total > 0 ? ((ctx.parsed / total)*100).toFixed(1) : 0;
              return ` ¬£${ctx.parsed.toLocaleString('en-GB',{minimumFractionDigits:2})} (${pct}%)`;
            }
          }
        }
      }
    }
  });

  // Custom legend with ¬£ value + %
  const legendEl = document.getElementById('costConsultantLegend');
  legendEl.innerHTML = sorted.map(([name, val], i) => {
    const pct = total > 0 ? ((val/total)*100).toFixed(1) : 0;
    return `<div style="display:flex;align-items:center;justify-content:space-between;padding:4px 0;border-bottom:1px solid #f0f2f5;font-size:12px;">
      <div style="display:flex;align-items:center;gap:8px;">
        <div style="width:10px;height:10px;border-radius:3px;background:${colors[i]};flex-shrink:0;"></div>
        <span style="color:#1a2035;font-weight:600;">${esc(name)}</span>
      </div>
      <div style="display:flex;align-items:center;gap:10px;">
        <span style="color:#6b7a99;">¬£${val.toLocaleString('en-GB',{minimumFractionDigits:2,maximumFractionDigits:2})}</span>
        <span style="color:#9ba5bb;min-width:36px;text-align:right;">${pct}%</span>
      </div>
    </div>`;
  }).join('');
}

function renderTable(rows) {
  if (!rows.length) {
    document.getElementById('tableEmpty').classList.remove('hidden');
    document.getElementById('tableWrap').classList.add('hidden');
    return;
  }

  document.getElementById('tableEmpty').classList.add('hidden');
  document.getElementById('tableWrap').classList.remove('hidden');

  // Aggregate per client
  const clientMap = {};
  rows.forEach(r => {
    if (!clientMap[r.client]) {
      clientMap[r.client] = { consultant: r.consultant, totalMargin: 0, erosion: 0, hours: 0, weeklyTotals: {} };
    }
    const c = clientMap[r.client];
    // Positive value = margin, negative or erosion-type metrics = erosion
    const isErosion = r.value < 0 ||
      ['holiday','ssp','smp','pension','pens','spp','internal','erosion','leakage'].some(k => r.metric.toLowerCase().includes(k));
    if (isErosion) {
      c.erosion += Math.abs(r.value);
    } else {
      c.totalMargin += r.value;
      // Simulate hours from value (use margin/hr metric if present, else estimate)
      c.hours += r.value / 4; // placeholder divisor; real data would have an Hours column
    }
    // Track per-week totals for trend
    if (r.week) {
      c.weeklyTotals[r.week] = (c.weeklyTotals[r.week] || 0) + (isErosion ? 0 : r.value);
    }
  });

  // Check if CSV has an explicit Margin_Hr or Hours column
  const hasHours = sourceRows.some(r => r.metric.toLowerCase().includes('hour') || r.metric.toLowerCase().includes('hr'));

  // Sort by totalMargin desc
  const sorted = Object.entries(clientMap).sort((a,b) => b[1].totalMargin - a[1].totalMargin);

  const tbody = document.getElementById('clientTableBody');
  tbody.innerHTML = sorted.map(([client, d]) => {
    const marginHr = d.hours > 0 ? d.totalMargin / d.hours : 0;
    const marginHrClass = marginHr >= 4 ? 'high' : marginHr >= 3 ? 'mid' : 'low';

    // Trend: compare last two weeks
    const weekNums = Object.keys(d.weeklyTotals).map(Number).sort((a,b)=>a-b);
    let trend = 'neutral';
    if (weekNums.length >= 2) {
      const prev = d.weeklyTotals[weekNums[weekNums.length-2]];
      const last = d.weeklyTotals[weekNums[weekNums.length-1]];
      trend = last >= prev ? 'up' : 'drop';
    }

    const trendHTML = trend === 'up'
      ? `<span class="trend-badge up">‚Üó Improvement</span>`
      : trend === 'drop'
      ? `<span class="trend-badge drop">‚Üì Dropping</span>`
      : `<span style="color:var(--text3);font-size:12px">‚Äî</span>`;

    const costsHTML = d.erosion > 0
      ? `<span class="td-erosion">-¬£${d.erosion.toLocaleString('en-GB',{minimumFractionDigits:2,maximumFractionDigits:2})}</span>`
      : `<span class="td-erosion zero">-¬£0.00</span>`;

    const marginHrDisplay = marginHr > 0
      ? `<span class="td-margin-hr ${marginHrClass}">¬£${marginHr.toFixed(2)}/hr</span>`
      : `<span class="td-margin-hr mid">‚Äî</span>`;

    return `<tr>
      <td>
        <div class="td-client-name">${esc(client)}</div>
        <div class="td-owner">${esc(d.consultant)}</div>
      </td>
      <td><span class="td-margin">¬£${d.totalMargin.toLocaleString('en-GB',{minimumFractionDigits:2,maximumFractionDigits:2})}</span></td>
      <td>${marginHrDisplay}</td>
      <td>${costsHTML}</td>
      <td>${trendHTML}</td>
    </tr>`;
  }).join('');
}

function esc(s) { const d = document.createElement('div'); d.textContent = String(s); return d.innerHTML; }

// No data until CSV is uploaded ‚Äî show placeholder KPIs
document.getElementById('kpiGross').textContent = '‚Äî';
document.getElementById('kpiSSP').textContent   = '‚Äî';
document.getElementById('kpiSMP').textContent   = '‚Äî';
document.getElementById('kpiNet').textContent   = '‚Äî';
</script>
</body>
</html>
