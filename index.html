<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Branch Financial Tracker</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=DM+Sans:wght@300;400;500&display=swap');
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#f4f6f9;--white:#ffffff;--border:#e8ecf1;
  --text:#1a2035;--text2:#6b7a99;--text3:#9ba5bb;
  --green:#2ecc8f;--red:#e84c4c;--blue:#4a90e2;--orange:#f0a830;
  --profit-green:#1db87a;--purple:#a855f7;--amber:#f0a830;
  --shadow:0 2px 12px rgba(0,0,0,0.07);--shadow-lg:0 4px 24px rgba(0,0,0,0.1);
  --radius:14px;
}
body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}

/* ‚îÄ‚îÄ Top Header ‚îÄ‚îÄ */
.page-header{
  background:var(--white);padding:16px 32px;
  border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;
  flex-wrap:wrap;gap:12px;position:sticky;top:0;z-index:50;
}
.page-title h1{font-size:20px;font-weight:800;color:var(--text);letter-spacing:-0.3px;}

/* ‚îÄ‚îÄ Page Nav Tabs ‚îÄ‚îÄ */
.page-nav{display:flex;align-items:center;gap:4px;background:var(--bg);border-radius:10px;padding:4px;}
.nav-tab{
  padding:7px 16px;border-radius:7px;font-size:12px;font-weight:700;
  letter-spacing:0.04em;cursor:pointer;border:none;background:transparent;
  color:var(--text2);transition:all 0.18s;font-family:inherit;
}
.nav-tab:hover{background:var(--white);color:var(--text);}
.nav-tab.active{background:var(--white);color:var(--text);box-shadow:0 1px 6px rgba(0,0,0,0.08);}
.nav-tab.active.tab-overview { border-bottom: 2px solid var(--blue); }
.nav-tab.active.tab-yield    { border-bottom: 2px solid var(--profit-green); }
.nav-tab.active.tab-risk     { border-bottom: 2px solid var(--red); }

/* ‚îÄ‚îÄ Header Controls ‚îÄ‚îÄ */
.header-controls{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
.search-wrap{position:relative;display:flex;align-items:center;}
.search-wrap svg{position:absolute;left:11px;color:var(--text3);pointer-events:none;}
.search-input{
  padding:8px 14px 8px 34px;border:1px solid var(--border);border-radius:8px;
  font-family:inherit;font-size:13px;color:var(--text);background:var(--white);
  outline:none;width:180px;transition:border-color 0.2s;
}
.search-input:focus{border-color:var(--blue);}
.search-input::placeholder{color:var(--text3);}
.filter-btn{
  display:flex;align-items:center;gap:6px;padding:8px 14px;
  border:1px solid var(--border);border-radius:8px;background:var(--white);
  font-family:inherit;font-size:13px;font-weight:500;color:var(--text);cursor:pointer;
}
.filter-btn select{border:none;background:transparent;font-family:inherit;font-size:13px;font-weight:500;color:var(--text);cursor:pointer;outline:none;padding:0;}
.upload-label{
  display:flex;align-items:center;gap:6px;padding:8px 16px;
  border:1.5px solid var(--blue);border-radius:8px;background:var(--white);
  font-family:inherit;font-size:13px;font-weight:600;color:var(--blue);cursor:pointer;
  transition:background 0.2s;position:relative;
}
.upload-label:hover{background:#f0f5ff;}
.upload-label input{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;}
.upload-info{font-size:11px;color:var(--text3);max-width:140px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.upload-error{font-size:11px;color:var(--red);}

/* ‚îÄ‚îÄ Pages ‚îÄ‚îÄ */
.page{display:none;}
.page.active{display:block;animation:fadeUp 0.3s ease both;}
@keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
.main{padding:24px 32px;}

/* ‚îÄ‚îÄ KPI Cards ‚îÄ‚îÄ */
.kpi-row{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:20px;}
@media(max-width:900px){.kpi-row{grid-template-columns:repeat(2,1fr);}}
.kpi-card{
  background:var(--white);border-radius:var(--radius);padding:20px 22px;
  box-shadow:var(--shadow);border:1px solid var(--border);transition:box-shadow 0.2s;
}
.kpi-card:hover{box-shadow:var(--shadow-lg);}
.kpi-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
.kpi-icon{width:34px;height:34px;border-radius:9px;display:flex;align-items:center;justify-content:center;}
.kpi-icon svg{width:15px;height:15px;}
.kpi-icon.blue{background:#eef3ff;} .kpi-icon.red{background:#fff0f0;}
.kpi-icon.green{background:#edfbf5;} .kpi-icon.purple{background:#f0f0ff;}
.kpi-icon.amber{background:#fffbeb;}
.kpi-label{font-size:10px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--text3);margin-bottom:4px;}
.kpi-value{font-size:26px;font-weight:800;letter-spacing:-0.5px;color:var(--text);}
.kpi-value.kpi-red{color:var(--red);} .kpi-value.kpi-green{color:var(--profit-green);}
.kpi-value.kpi-purple{color:#6366f1;} .kpi-value.kpi-blue{color:var(--blue);}
.kpi-value.kpi-amber{color:var(--amber);}
.kpi-badge{font-size:9px;font-weight:700;letter-spacing:0.06em;text-transform:uppercase;padding:2px 7px;border-radius:20px;}
.kpi-badge.red{background:#fff0f0;color:var(--red);border:1px solid #ffd5d5;}

/* ‚îÄ‚îÄ Chart cards ‚îÄ‚îÄ */
.bottom-row{display:grid;grid-template-columns:1fr 340px;gap:16px;margin-bottom:16px;}
@media(max-width:1100px){.bottom-row{grid-template-columns:1fr;}}
.two-col{display:grid;grid-template-columns:1fr 340px;gap:16px;margin-bottom:16px;}
.chart-card{
  background:var(--white);border-radius:var(--radius);padding:22px 24px;
  box-shadow:var(--shadow);border:1px solid var(--border);
}
.chart-card-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:16px;}
.chart-card-title{font-size:12px;font-weight:800;letter-spacing:0.06em;text-transform:uppercase;color:var(--text2);}
.chart-view-label{font-size:10px;color:var(--text3);}
.chart-wrap{position:relative;}
.donut-wrap{display:flex;align-items:center;gap:0;}

/* ‚îÄ‚îÄ Empty overlays ‚îÄ‚îÄ */
.empty-overlay{
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:10px;padding:40px 20px;color:var(--text3);font-size:13px;text-align:center;
}
.empty-overlay span{font-size:28px;}

/* ‚îÄ‚îÄ Table ‚îÄ‚îÄ */
.table-card{background:var(--white);border-radius:var(--radius);padding:0;box-shadow:var(--shadow);border:1px solid var(--border);overflow:hidden;}
.client-table{width:100%;border-collapse:collapse;}
.client-table th{
  font-size:10px;font-weight:800;letter-spacing:0.1em;text-transform:uppercase;
  color:var(--text3);padding:12px 16px;text-align:left;
  border-bottom:1px solid var(--border);background:var(--bg);
}
.client-table td{font-size:13px;padding:11px 16px;border-bottom:1px solid var(--border);color:var(--text2);}
.client-table tbody tr:last-child td{border-bottom:none;}
.client-table tbody tr:hover{background:#f9fbff;}
.td-client-name{font-weight:700;color:var(--text);font-size:13px;}
.td-owner{font-size:11px;color:var(--text3);margin-top:2px;}
.td-margin{font-weight:800;color:var(--text);}
.td-erosion{color:var(--red);font-weight:700;}
.td-erosion.zero{color:var(--text3);}
.td-margin-hr{font-size:11px;font-weight:700;padding:3px 9px;border-radius:20px;}
.td-margin-hr.high{background:#edfbf5;color:#1a9e6a;}
.td-margin-hr.mid{background:#fffbeb;color:#c07a10;}
.td-margin-hr.low{background:#fff0f0;color:var(--red);}
.trend-badge{display:inline-flex;align-items:center;gap:4px;font-size:11px;font-weight:700;padding:3px 10px;border-radius:5px;}
.trend-badge.drop{color:#c0392b;background:#fff0f0;}
.trend-badge.up{color:#1a9e6a;background:#eafaf3;}
.wow-badge{display:inline-flex;align-items:center;gap:3px;font-size:10px;font-weight:700;padding:2px 8px;border-radius:20px;}
.wow-badge.improvement{background:#eafaf3;color:#1a9e6a;}
.wow-badge.dropping{background:#fff0f0;color:var(--red);}
.wow-badge.neutral{background:var(--bg);color:var(--text3);}
.wow-badge.increasing{background:#fff7ed;color:#c05e10;}

/* ‚îÄ‚îÄ Yield page ‚îÄ‚îÄ */
.quadrant-legend{display:flex;gap:16px;flex-wrap:wrap;margin-top:12px;}
.q-dot{display:inline-flex;align-items:center;gap:6px;font-size:10px;font-weight:700;}
.q-dot::before{content:'';width:8px;height:8px;border-radius:50%;background:currentColor;display:inline-block;}
.rank-list{max-height:340px;overflow-y:auto;}
.rank-list::-webkit-scrollbar{width:3px;}
.rank-list::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
.rank-item{
  display:flex;align-items:center;justify-content:space-between;
  padding:9px 12px;border-radius:9px;margin-bottom:3px;
  background:var(--bg);transition:background 0.15s;
}
.rank-item:hover{background:#edf0f7;}
.rank-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.rank-name{font-size:12px;font-weight:700;color:var(--text);}
.rank-meta{font-size:10px;color:var(--text3);margin-top:1px;}
.rank-val{font-size:12px;font-weight:800;text-align:right;}
.rank-sub{font-size:10px;color:var(--text3);margin-top:1px;}

/* ‚îÄ‚îÄ Risk page ‚îÄ‚îÄ */
.risk-section{margin-bottom:22px;}
.risk-section-header{
  display:flex;align-items:center;gap:10px;margin-bottom:12px;
  font-size:11px;font-weight:800;letter-spacing:0.08em;text-transform:uppercase;
}
.risk-count-badge{
  font-size:10px;font-weight:800;padding:2px 9px;border-radius:20px;
  background:var(--red);color:#fff;
}
.risk-count-badge.amber{background:var(--amber);}
.risk-cards-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px;}
.risk-card{
  background:var(--white);border-radius:12px;padding:16px 18px;
  border:1px solid var(--border);border-left:4px solid var(--red);
  box-shadow:var(--shadow);transition:box-shadow 0.2s;
}
.risk-card:hover{box-shadow:var(--shadow-lg);}
.risk-card.amber-card{border-left-color:var(--amber);}
.risk-card-name{font-size:13px;font-weight:800;color:var(--text);}
.risk-card-owner{font-size:10px;color:var(--text3);margin-bottom:10px;}
.risk-flags{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:10px;}
.rflag{font-size:9px;font-weight:700;letter-spacing:0.06em;text-transform:uppercase;padding:3px 9px;border-radius:20px;}
.rflag.red{background:#fff0f0;color:var(--red);}
.rflag.amber{background:#fffbeb;color:var(--amber);}
.rflag.green{background:#edfbf5;color:var(--profit-green);}
.risk-metrics-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.rm-label{font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:0.06em;}
.rm-val{font-size:13px;font-weight:800;color:var(--text);}
.risk-empty{padding:20px;color:var(--text3);font-size:12px;}

/* ‚îÄ‚îÄ Scatter ‚îÄ‚îÄ */
#chartScatterWrap{position:relative;height:320px;}

/* ‚îÄ‚îÄ Utility ‚îÄ‚îÄ */
.hidden{display:none !important;}
.fade{animation:fadeUp 0.35s ease both;}
.section-gap{margin-top:16px;}
</style>
</head>
<body>

<!-- ‚îÄ‚îÄ Header ‚îÄ‚îÄ -->
<div class="page-header">
  <div style="display:flex;align-items:center;gap:20px;flex-wrap:wrap;">
    <div class="page-title"><h1>Branch Financial Tracker</h1></div>
    <div class="page-nav">
      <button class="nav-tab tab-overview active" onclick="switchPage('overview',this)">üìä Overview</button>
      <button class="nav-tab tab-yield"    onclick="switchPage('yield',this)">‚ö° Yield Desk</button>
      <button class="nav-tab tab-risk"     onclick="switchPage('risk',this)">‚ö†Ô∏è Risk Analysis</button>
    </div>
  </div>

  <div class="header-controls">
    <span class="upload-info" id="uploadName"></span>
    <span class="upload-error" id="uploadError"></span>
    <div class="search-wrap">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      <input type="text" class="search-input" id="searchInput" placeholder="Find client‚Ä¶"/>
    </div>
    <div class="filter-btn">üìÖ
      <select id="filterPeriod"><option value="All">Weekly</option></select>
    </div>
    <div class="filter-btn">
      <select id="filterMonth"><option value="All">All Months</option></select>
    </div>
    <div class="filter-btn">
      <select id="filterConsultant"><option value="All">All Recruiter</option></select>
    </div>
    <label class="upload-label">‚Üë Upload CSV
      <input type="file" accept=".csv" id="csvInput"/>
    </label>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     PAGE: OVERVIEW
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page active" id="page-overview">
<div class="main">

  <!-- KPIs -->
  <div class="kpi-row">
    <div class="kpi-card fade">
      <div class="kpi-top"><div class="kpi-icon blue"><svg viewBox="0 0 24 24" fill="none" stroke="#4a90e2" stroke-width="2.5"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></div></div>
      <div class="kpi-label">Gross Margin</div>
      <div class="kpi-value" id="kpiGross">‚Äî</div>
    </div>
    <div class="kpi-card fade" style="animation-delay:.05s">
      <div class="kpi-top"><div class="kpi-icon red"><svg viewBox="0 0 24 24" fill="none" stroke="#e84c4c" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div></div>
      <div class="kpi-label">Total Cost</div>
      <div class="kpi-value kpi-red" id="kpiTotalCost">‚Äî</div>
    </div>
    <div class="kpi-card fade" style="animation-delay:.1s">
      <div class="kpi-top"><div class="kpi-icon green"><svg viewBox="0 0 24 24" fill="none" stroke="#1db87a" stroke-width="2.5"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg></div></div>
      <div class="kpi-label">Net Profit</div>
      <div class="kpi-value kpi-green" id="kpiNet">‚Äî</div>
    </div>
    <div class="kpi-card fade" style="animation-delay:.15s">
      <div class="kpi-top"><div class="kpi-icon purple"><svg viewBox="0 0 24 24" fill="none" stroke="#6366f1" stroke-width="2.5"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></div></div>
      <div class="kpi-label">Total Spend</div>
      <div class="kpi-value kpi-purple" id="kpiAnnual">‚Äî</div>
    </div>
  </div>

  <!-- Row 1: Weekly Trend + Consultant Donut -->
  <div class="bottom-row">
    <div class="chart-card fade" style="animation-delay:.2s">
      <div class="chart-card-header">
        <div class="chart-card-title">Weekly Margin Trend (Top 5 Active)</div>
        <div class="chart-view-label" id="viewLabel">View: Weekly</div>
      </div>
      <div id="barEmpty" class="empty-overlay"><span>üìä</span>Upload a CSV to see account data</div>
      <div id="barChartWrap" class="chart-wrap hidden" style="height:300px"><canvas id="chartBar"></canvas></div>
    </div>
    <div class="chart-card fade" style="animation-delay:.25s">
      <div class="chart-card-header"><div class="chart-card-title">Consultant Share</div></div>
      <div id="donutEmpty" class="empty-overlay"><span>üç©</span>No data yet</div>
      <div id="donutWrap" class="hidden">
        <div class="donut-wrap" style="height:240px"><canvas id="chartDonut"></canvas></div>
      </div>
    </div>
  </div>

  <!-- Row 2: Gross vs Cost + Cost by Consultant -->
  <div class="two-col">
    <div class="chart-card fade" style="animation-delay:.28s">
      <div class="chart-card-header">
        <div class="chart-card-title">Gross vs Operating Cost</div>
        <div class="chart-view-label">Margin erosion across top accounts</div>
      </div>
      <div id="costsEmpty" class="empty-overlay"><span>üí∏</span>Upload a CSV to see cost breakdown</div>
      <div id="costsChartWrap" class="hidden" style="position:relative;height:280px;"><canvas id="chartCosts"></canvas></div>
    </div>
    <div class="chart-card fade" style="animation-delay:.32s">
      <div class="chart-card-header"><div class="chart-card-title">Cost by Consultant</div></div>
      <div id="costConsultantEmpty" class="empty-overlay"><span>üë§</span>No data yet</div>
      <div id="costConsultantWrap" class="hidden">
        <div style="position:relative;height:200px;"><canvas id="chartCostConsultant"></canvas></div>
        <div id="costConsultantLegend" style="margin-top:12px;"></div>
      </div>
    </div>
  </div>

  <!-- Row 3: Cost Breakdown by Client -->
  <div class="chart-card fade section-gap" style="animation-delay:.34s">
    <div class="chart-card-header">
      <div class="chart-card-title">Cost Breakdown by Client</div>
      <div class="chart-view-label">Holiday ¬∑ SSP ¬∑ SMP ¬∑ Pension ¬∑ Other ‚Äî per client</div>
    </div>
    <div id="holidayEmpty" class="empty-overlay"><span>üìã</span>No cost data found</div>
    <div id="holidayChartWrap" class="hidden" style="position:relative;height:320px;"><canvas id="chartHoliday"></canvas></div>
  </div>

  <!-- Client Table -->
  <div class="table-card fade section-gap" style="animation-delay:.36s">
    <div id="tableEmpty" class="empty-overlay"><span>üìã</span>Upload a CSV to see client breakdown</div>
    <div id="tableWrap" class="hidden">
      <table class="client-table">
        <thead><tr>
          <th>Client / Owner</th><th>Total Margin</th><th>Margin/Hr</th><th>Costs</th><th>WoW Trend</th>
        </tr></thead>
        <tbody id="clientTableBody"></tbody>
      </table>
    </div>
  </div>

</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     PAGE: YIELD DESK
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="page-yield">
<div class="main">

  <div class="kpi-row">
    <div class="kpi-card fade">
      <div class="kpi-top">
        <div class="kpi-icon blue"><svg viewBox="0 0 24 24" fill="none" stroke="#4a90e2" stroke-width="2.5"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg></div>
        <span class="kpi-badge red" id="yieldBadgeRisk"></span>
      </div>
      <div class="kpi-label">Branch Yield / Hr</div>
      <div class="kpi-value kpi-blue" id="kpiYieldAvg">‚Äî</div>
    </div>
    <div class="kpi-card fade" style="animation-delay:.05s">
      <div class="kpi-top">
        <div class="kpi-icon green"><svg viewBox="0 0 24 24" fill="none" stroke="#1db87a" stroke-width="2.5"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg></div>
      </div>
      <div class="kpi-label">‚òÖ Stars (High yield + vol)</div>
      <div class="kpi-value kpi-green" id="kpiStars">‚Äî</div>
    </div>
    <div class="kpi-card fade" style="animation-delay:.1s">
      <div class="kpi-top">
        <div class="kpi-icon red"><svg viewBox="0 0 24 24" fill="none" stroke="#e84c4c" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg></div>
      </div>
      <div class="kpi-label">‚óè Risk (Low yield + high vol)</div>
      <div class="kpi-value kpi-red" id="kpiRiskCount">‚Äî</div>
    </div>
    <div class="kpi-card fade" style="animation-delay:.15s">
      <div class="kpi-top">
        <div class="kpi-icon amber"><svg viewBox="0 0 24 24" fill="none" stroke="#f0a830" stroke-width="2.5"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></div>
      </div>
      <div class="kpi-label">‚ñ≤ Drains (Low yield + low vol)</div>
      <div class="kpi-value kpi-amber" id="kpiDrains">‚Äî</div>
    </div>
  </div>

  <div class="bottom-row">
    <div class="chart-card fade" style="animation-delay:.2s">
      <div class="chart-card-header">
        <div class="chart-card-title">Strategy Quadrant</div>
        <div class="chart-view-label">Yield (¬£/hr) vs Volume (hours) ‚Äî each dot = one client</div>
      </div>
      <div id="scatterEmpty" class="empty-overlay"><span>üéØ</span>Upload CSV with Hours data to enable yield analysis</div>
      <div id="chartScatterWrap" class="hidden" style="height:320px;"><canvas id="chartScatter"></canvas></div>
      <div class="quadrant-legend" id="quadrantLegend" style="display:none;">
        <span class="q-dot" style="color:#1db87a;">Stars</span>
        <span class="q-dot" style="color:#4a90e2;">Boutique</span>
        <span class="q-dot" style="color:#f0a830;">Drain</span>
        <span class="q-dot" style="color:#e84c4c;">Risk</span>
      </div>
    </div>
    <div class="chart-card fade" style="animation-delay:.25s">
      <div class="chart-card-header">
        <div class="chart-card-title">Yield Ranking</div>
        <div class="chart-view-label">¬£/hr ‚Äî highest to lowest</div>
      </div>
      <div id="yieldRankEmpty" class="empty-overlay"><span>üìà</span>No data yet</div>
      <div id="yieldRankList" class="rank-list hidden"></div>
    </div>
  </div>

</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     PAGE: RISK ANALYSIS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="page-risk">
<div class="main">

  <div class="kpi-row">
    <div class="kpi-card fade">
      <div class="kpi-top">
        <div class="kpi-icon red"><svg viewBox="0 0 24 24" fill="none" stroke="#e84c4c" stroke-width="2.5"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></div>
      </div>
      <div class="kpi-label">Total Accounts Flagged</div>
      <div class="kpi-value kpi-red" id="riskTotalFlagged">‚Äî</div>
    </div>
    <div class="kpi-card fade" style="animation-delay:.05s">
      <div class="kpi-top">
        <div class="kpi-icon red"><svg viewBox="0 0 24 24" fill="none" stroke="#e84c4c" stroke-width="2.5"><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/></svg></div>
      </div>
      <div class="kpi-label">‚Üì Dropping Trend</div>
      <div class="kpi-value kpi-red" id="riskDropCount">‚Äî</div>
    </div>
    <div class="kpi-card fade" style="animation-delay:.1s">
      <div class="kpi-top">
        <div class="kpi-icon amber"><svg viewBox="0 0 24 24" fill="none" stroke="#f0a830" stroke-width="2.5"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></div>
      </div>
      <div class="kpi-label">High Cost Impact (&gt;50%)</div>
      <div class="kpi-value kpi-amber" id="riskHighCostCount">‚Äî</div>
    </div>
    <div class="kpi-card fade" style="animation-delay:.15s">
      <div class="kpi-top">
        <div class="kpi-icon green"><svg viewBox="0 0 24 24" fill="none" stroke="#1db87a" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg></div>
      </div>
      <div class="kpi-label">‚úÖ Clean Accounts</div>
      <div class="kpi-value kpi-green" id="riskCleanCount">‚Äî</div>
    </div>
  </div>

  <!-- Dropping trend section -->
  <div class="risk-section fade" style="animation-delay:.2s">
    <div class="risk-section-header" style="color:var(--red);">
      ‚Üì Dropping Trend Accounts
      <span class="risk-count-badge" id="riskDropBadge">0</span>
    </div>
    <div class="risk-cards-grid" id="riskDropGrid">
      <div class="risk-empty">Upload a CSV to see risk analysis.</div>
    </div>
  </div>

  <!-- High cost impact section -->
  <div class="risk-section fade" style="animation-delay:.25s">
    <div class="risk-section-header" style="color:var(--amber);">
      üí∏ High Cost Impact (&gt;50% of Gross)
      <span class="risk-count-badge amber" id="riskCostBadge">0</span>
    </div>
    <div class="risk-cards-grid" id="riskCostGrid">
      <div class="risk-empty">Upload a CSV to see risk analysis.</div>
    </div>
  </div>

</div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let sourceRows = [];
let barChart, donutChart, costsChart, costConsultantChart, holidayChart, scatterChart;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const getCI = (obj,...names) => {
  const keys = Object.keys(obj||{});
  for(const n of names){
    const k = keys.find(x=>x.toLowerCase()===n.toLowerCase());
    if(k!==undefined) return obj[k];
  }
  return '';
};
const parseWeek = x => { const m=String(x??'').match(/(\d+)/); return m?Number(m[1]):0; };
const toNum     = x => { const n=Number(String(x??'').replace(/[¬£,]/g,'').trim()); return isFinite(n)?n:0; };
const fmtGBP    = n => '¬£'+Math.abs(n).toLocaleString('en-GB',{minimumFractionDigits:2,maximumFractionDigits:2});
const esc       = s => { const d=document.createElement('div'); d.textContent=String(s); return d.innerHTML; };

// Use Cost_Type column directly ‚Äî 'expense' = cost row, 'income' = margin/hours
const isCostRow = r => String(r.costType||'').toLowerCase()==='expense';
const isIncomeRow = r => String(r.costType||'').toLowerCase()==='income';
const isHoursRow = r => r.metric.toLowerCase().includes('hour') || r.metric.toLowerCase().includes('hrs');

const CHART_FONT = 'Plus Jakarta Sans';
const TT = {
  backgroundColor:'#fff',borderColor:'#e8ecf1',borderWidth:1,
  titleColor:'#6b7a99',bodyColor:'#1a2035',
  titleFont:{family:CHART_FONT,size:11},bodyFont:{family:CHART_FONT,size:12,weight:'600'},
};
const TICK = color => ({ color, font:{family:CHART_FONT,size:11} });
const Q_COLOR = {star:'#1db87a',boutique:'#4a90e2',drain:'#f0a830',risk:'#e84c4c'};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CSV UPLOAD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('csvInput').addEventListener('change', e => {
  const file = e.target.files?.[0]; if(!file) return;
  setError('');
  document.getElementById('uploadName').textContent = file.name;
  Papa.parse(file, {
    header:true, skipEmptyLines:true,
    complete:({errors,data}) => {
      if(errors?.length){ setError(errors[0].message||'CSV parse error'); return; }
      const rows = (Array.isArray(data)?data:[]).map(r=>({
        client:     String(getCI(r,'client')).trim(),
        consultant: String(getCI(r,'consultant')||'Unknown').trim()||'Unknown',
        metric:     String(getCI(r,'metric')).trim(),
        costType:   String(getCI(r,'cost_type','costtype')||'').trim(),
        value:      toNum(getCI(r,'value')),
        prevValue:  toNum(getCI(r,'prev_week_value','prev_value')),
        wowTrend:   String(getCI(r,'wow_trend','wowtrend')||'').trim(),
        week:       parseWeek(getCI(r,'week')),
        month:      Number(getCI(r,'month_num','month'))||0,
        isLatest:   String(getCI(r,'is_latest_week','islatestweek')||'').toLowerCase()==='yes',
      })).filter(x=>x.client&&x.metric);
      if(!rows.length){ setError('No usable rows found.'); return; }
      sourceRows = rows;
      initFilters();
      renderAll();
    }
  });
  e.target.value='';
});
function setError(msg){ document.getElementById('uploadError').textContent=msg; }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FILTERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initFilters(){
  const consultants=[...new Set(sourceRows.map(r=>r.consultant))].sort();
  const months=[...new Set(sourceRows.map(r=>r.month).filter(Boolean))].sort((a,b)=>a-b);
  const weeks=[...new Set(sourceRows.map(r=>r.week).filter(Boolean))].sort((a,b)=>a-b);
  const cs=document.getElementById('filterConsultant');
  cs.innerHTML='<option value="All">All Recruiter</option>';
  consultants.forEach(c=>{const o=document.createElement('option');o.value=c;o.textContent=c;cs.appendChild(o);});
  const ms=document.getElementById('filterMonth');
  ms.innerHTML='<option value="All">All Months</option>';
  months.forEach(m=>{const o=document.createElement('option');o.value=m;o.textContent=`Month ${m}`;ms.appendChild(o);});
  const ps=document.getElementById('filterPeriod');
  ps.innerHTML='<option value="All">Weekly</option>';
  weeks.forEach(w=>{const o=document.createElement('option');o.value=w;o.textContent=`Week ${w}`;ps.appendChild(o);});
  ['filterConsultant','filterMonth','filterPeriod','searchInput'].forEach(id=>{
    const el=document.getElementById(id);
    el.addEventListener('change',renderAll); el.addEventListener('input',renderAll);
  });
}
function getFiltered(){
  const consultant=document.getElementById('filterConsultant')?.value||'All';
  const month=document.getElementById('filterMonth')?.value||'All';
  const period=document.getElementById('filterPeriod')?.value||'All';
  const search=(document.getElementById('searchInput')?.value||'').toLowerCase();
  return sourceRows.filter(r=>
    (consultant==='All'||r.consultant===consultant)&&
    (month==='All'||String(r.month)===String(month))&&
    (period==='All'||String(r.week)===String(period))&&
    (!search||r.client.toLowerCase().includes(search))
  );
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER ALL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderAll(){
  const rows=getFiltered();
  renderKPIs(rows);
  renderBarChart(rows);
  renderDonut(rows);
  renderCostsChart(rows);
  renderCostConsultantChart(rows);
  renderHolidayChart(rows);
  renderTable(rows);
  renderYieldPage(rows);
  renderRiskPage(rows);
  const period=document.getElementById('filterPeriod')?.value;
  document.getElementById('viewLabel').textContent=period&&period!=='All'?`View: Week ${period}`:'View: Weekly';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// OVERVIEW ‚Äî KPIs
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderKPIs(rows){
  const incomeRows = rows.filter(r=>isIncomeRow(r)&&!isHoursRow(r));
  const grossMargin = incomeRows.filter(r=>r.metric.toLowerCase().includes('margin')).reduce((s,r)=>s+r.value,0)
    || incomeRows.reduce((s,r)=>s+r.value,0);
  const totalCost = rows.filter(r=>isCostRow(r)).reduce((s,r)=>s+Math.abs(r.value),0);
  const netProfit = grossMargin - totalCost;
  const totalSpend = rows.filter(r=>r.value>0&&!isHoursRow(r)).reduce((s,r)=>s+r.value,0);
  document.getElementById('kpiGross').textContent     = fmtGBP(grossMargin);
  document.getElementById('kpiTotalCost').textContent = fmtGBP(totalCost);
  document.getElementById('kpiNet').textContent       = fmtGBP(netProfit);
  document.getElementById('kpiAnnual').textContent    = fmtGBP(totalSpend);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// OVERVIEW ‚Äî WEEKLY TREND
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderBarChart(rows){
  const marginRows = rows.filter(r=>isIncomeRow(r)&&r.metric.toLowerCase().includes('margin'));
  if(!marginRows.length){
    show('barEmpty',true); show('barChartWrap',false); return;
  }
  const clientTotals={};
  marginRows.forEach(r=>{ clientTotals[r.client]=(clientTotals[r.client]||0)+r.value; });
  const top5=Object.entries(clientTotals).sort((a,b)=>b[1]-a[1]).slice(0,5).map(x=>x[0]);
  const weeks=[...new Set(marginRows.map(r=>r.week).filter(Boolean))].sort((a,b)=>a-b);
  const WK_COLORS=['#5b8dee','#7aa8f5','#9dc3f7','#bcd6f9','#d9ebfc'];
  const datasets=weeks.map((w,i)=>({
    label:`Week ${w}`,
    data:top5.map(c=>marginRows.filter(r=>r.client===c&&r.week===w).reduce((s,r)=>s+r.value,0)),
    backgroundColor:WK_COLORS[i%WK_COLORS.length],borderRadius:3,borderSkipped:false,
  }));
  show('barEmpty',false); show('barChartWrap',true);
  if(barChart) barChart.destroy();
  barChart=new Chart(document.getElementById('chartBar'),{
    type:'bar',data:{labels:top5,datasets},
    options:{responsive:true,maintainAspectRatio:false,
      plugins:{legend:{display:true,position:'top',align:'end',labels:{color:'#6b7a99',font:{family:CHART_FONT,size:11},boxWidth:10,boxHeight:10,borderRadius:3,padding:12}},tooltip:{...TT,callbacks:{label:ctx=>` ${fmtGBP(ctx.parsed.y)}`}}},
      scales:{x:{grid:{display:false},ticks:TICK('#6b7a99'),border:{color:'#e8ecf1'}},y:{grid:{color:'#f0f2f5'},ticks:{...TICK('#9ba5bb'),callback:v=>Number(v).toLocaleString()},border:{color:'#e8ecf1'}}}
    }
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// OVERVIEW ‚Äî CONSULTANT DONUT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDonut(rows){
  const marginRows=rows.filter(r=>isIncomeRow(r)&&r.metric.toLowerCase().includes('margin'));
  if(!marginRows.length){ show('donutEmpty',true); show('donutWrap',false); return; }
  const conMap={};
  marginRows.forEach(r=>{ conMap[r.consultant]=(conMap[r.consultant]||0)+r.value; });
  const segs=Object.entries(conMap).sort((a,b)=>b[1]-a[1]);
  show('donutEmpty',false); show('donutWrap',true);
  const COLORS=['#4a90e2','#2ecc8f','#f0a830','#e84c4c','#a855f7','#22d3ee','#fb923c','#34d399'];
  const labels=segs.map(x=>x[0]), values=segs.map(x=>x[1]);
  const colors=COLORS.slice(0,labels.length);
  if(donutChart) donutChart.destroy();
  donutChart=new Chart(document.getElementById('chartDonut'),{
    type:'doughnut',
    data:{labels,datasets:[{data:values,backgroundColor:colors,borderWidth:3,borderColor:'#fff'}]},
    options:{responsive:true,maintainAspectRatio:false,cutout:'65%',
      plugins:{legend:{display:true,position:'right',labels:{color:'#6b7a99',font:{family:CHART_FONT,size:12},boxWidth:10,boxHeight:10,borderRadius:3,padding:12}},
        tooltip:{...TT,callbacks:{label:ctx=>{const t=ctx.dataset.data.reduce((a,b)=>a+b,0);return ` ${fmtGBP(ctx.parsed)} (${t>0?((ctx.parsed/t)*100).toFixed(1):0}%)`;}}}
      }
    }
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// OVERVIEW ‚Äî GROSS VS COST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderCostsChart(rows){
  const cMap={};
  rows.filter(r=>!isHoursRow(r)).forEach(r=>{
    if(!cMap[r.client]) cMap[r.client]={gross:0,cost:0};
    if(isCostRow(r)) cMap[r.client].cost+=Math.abs(r.value);
    else if(isIncomeRow(r)&&r.metric.toLowerCase().includes('margin')) cMap[r.client].gross+=r.value;
  });
  const top8=Object.entries(cMap).sort((a,b)=>(b[1].gross+b[1].cost)-(a[1].gross+a[1].cost)).slice(0,8);
  if(!top8.length){ show('costsEmpty',true); show('costsChartWrap',false); return; }
  show('costsEmpty',false); show('costsChartWrap',true);
  if(costsChart) costsChart.destroy();
  costsChart=new Chart(document.getElementById('chartCosts'),{
    type:'bar',
    data:{labels:top8.map(x=>x[0]),datasets:[
      {label:'Gross',data:top8.map(x=>x[1].gross),backgroundColor:'#2ecc8f',borderRadius:3,stack:'s'},
      {label:'Cost', data:top8.map(x=>x[1].cost), backgroundColor:'#e84c4c',borderRadius:3,stack:'s'},
    ]},
    options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,
      plugins:{legend:{display:true,position:'bottom',align:'center',labels:{color:'#6b7a99',font:{family:CHART_FONT,size:12},boxWidth:12,boxHeight:12,borderRadius:3,padding:16}},
        tooltip:{...TT,callbacks:{label:ctx=>` ${ctx.dataset.label}: ${fmtGBP(ctx.parsed.x)}`}}},
      scales:{x:{stacked:true,grid:{color:'#f0f2f5'},ticks:{...TICK('#9ba5bb'),callback:v=>'¬£'+Number(v).toLocaleString()},border:{color:'#e8ecf1'}},
              y:{stacked:true,grid:{display:false},ticks:TICK('#6b7a99'),border:{color:'#e8ecf1'}}}
    }
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// OVERVIEW ‚Äî COST BY CONSULTANT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderCostConsultantChart(rows){
  const costRows=rows.filter(r=>isCostRow(r));
  if(!costRows.length){ show('costConsultantEmpty',true); show('costConsultantWrap',false); return; }
  show('costConsultantEmpty',false); show('costConsultantWrap',true);
  const conCosts={};
  costRows.forEach(r=>{ conCosts[r.consultant]=(conCosts[r.consultant]||0)+Math.abs(r.value); });
  const sorted=Object.entries(conCosts).sort((a,b)=>b[1]-a[1]);
  const COLORS=['#4a90e2','#2ecc8f','#f0a830','#e84c4c','#a855f7','#22d3ee','#fb923c','#34d399'];
  const colors=COLORS.slice(0,sorted.length);
  const total=sorted.reduce((s,[,v])=>s+v,0);
  if(costConsultantChart) costConsultantChart.destroy();
  costConsultantChart=new Chart(document.getElementById('chartCostConsultant'),{
    type:'doughnut',
    data:{labels:sorted.map(x=>x[0]),datasets:[{data:sorted.map(x=>x[1]),backgroundColor:colors,borderWidth:3,borderColor:'#fff'}]},
    options:{responsive:true,maintainAspectRatio:false,cutout:'65%',
      plugins:{legend:{display:false},tooltip:{...TT,callbacks:{label:ctx=>{const pct=total>0?((ctx.parsed/total)*100).toFixed(1):0;return ` ${fmtGBP(ctx.parsed)} (${pct}%)`;}}}}}
  });
  document.getElementById('costConsultantLegend').innerHTML=sorted.map(([name,val],i)=>{
    const pct=total>0?((val/total)*100).toFixed(1):0;
    return `<div style="display:flex;align-items:center;justify-content:space-between;padding:4px 0;border-bottom:1px solid #f0f2f5;font-size:12px;">
      <div style="display:flex;align-items:center;gap:7px;"><div style="width:9px;height:9px;border-radius:2px;background:${colors[i]};flex-shrink:0;"></div><span style="font-weight:700;color:#1a2035;">${esc(name)}</span></div>
      <div style="display:flex;gap:10px;"><span style="color:#6b7a99;">${fmtGBP(val)}</span><span style="color:#9ba5bb;min-width:34px;text-align:right;">${pct}%</span></div>
    </div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// OVERVIEW ‚Äî COST BREAKDOWN BY CLIENT (stacked metrics)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderHolidayChart(rows){
  const costRows=rows.filter(r=>isCostRow(r));
  if(!costRows.length){ show('holidayEmpty',true); show('holidayChartWrap',false); return; }
  show('holidayEmpty',false); show('holidayChartWrap',true);
  const clientMetricMap={};
  costRows.forEach(r=>{
    if(!clientMetricMap[r.client]) clientMetricMap[r.client]={};
    clientMetricMap[r.client][r.metric]=(clientMetricMap[r.client][r.metric]||0)+Math.abs(r.value);
  });
  const top10=Object.entries(clientMetricMap).map(([c,m])=>[c,Object.values(m).reduce((s,v)=>s+v,0)])
    .sort((a,b)=>b[1]-a[1]).slice(0,10).map(x=>x[0]);
  const allMetrics=[...new Set(costRows.map(r=>r.metric))].sort((a,b)=>a.toLowerCase().includes('holiday')?-1:1);
  const MCOLS=['#4a90e2','#e84c4c','#f0a830','#2ecc8f','#a855f7','#22d3ee','#fb923c','#f472b6'];
  if(holidayChart) holidayChart.destroy();
  holidayChart=new Chart(document.getElementById('chartHoliday'),{
    type:'bar',
    data:{labels:top10,datasets:allMetrics.map((m,i)=>({
      label:m,data:top10.map(c=>(clientMetricMap[c]||{})[m]||0),
      backgroundColor:MCOLS[i%MCOLS.length],borderRadius:3,borderSkipped:false,stack:'costs',
    }))},
    options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,
      plugins:{legend:{display:true,position:'bottom',align:'center',labels:{color:'#6b7a99',font:{family:CHART_FONT,size:11},boxWidth:11,boxHeight:11,borderRadius:3,padding:14}},
        tooltip:{...TT,callbacks:{label:ctx=>ctx.parsed.x>0?` ${ctx.dataset.label}: ${fmtGBP(ctx.parsed.x)}`:null,afterBody:items=>{const t=items.reduce((s,i)=>s+i.parsed.x,0);return t>0?[`‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ`,`Total: ${fmtGBP(t)}`]:[];}},filter:i=>i.parsed.x>0}},
      scales:{x:{stacked:true,grid:{color:'#f0f2f5'},ticks:{...TICK('#9ba5bb'),callback:v=>'¬£'+Number(v).toLocaleString()},border:{color:'#e8ecf1'}},
              y:{stacked:true,grid:{display:false},ticks:TICK('#6b7a99'),border:{color:'#e8ecf1'}}}
    }
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// OVERVIEW ‚Äî CLIENT TABLE
// Uses WoW_Trend directly from CSV
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderTable(rows){
  if(!rows.length){ show('tableEmpty',true); show('tableWrap',false); return; }
  show('tableEmpty',false); show('tableWrap',true);

  // Build client map ‚Äî use Cost_Type to separate margin vs costs
  const cMap={};
  rows.forEach(r=>{
    if(!cMap[r.client]) cMap[r.client]={consultant:r.consultant,margin:0,cost:0,hours:0,wowTrend:''};
    const c=cMap[r.client];
    if(isHoursRow(r)) { c.hours+=Math.abs(r.value); }
    else if(isCostRow(r)) { c.cost+=Math.abs(r.value); }
    else if(isIncomeRow(r)&&r.metric.toLowerCase().includes('margin')) { c.margin+=r.value; }
    // Capture latest WoW trend for margin rows
    if(r.metric.toLowerCase().includes('margin')&&r.wowTrend) c.wowTrend=r.wowTrend;
  });

  const sorted=Object.entries(cMap).sort((a,b)=>b[1].margin-a[1].margin);

  document.getElementById('clientTableBody').innerHTML=sorted.map(([client,d])=>{
    const marginHr=d.hours>0?d.margin/d.hours:0;
    const mhClass=marginHr>=4?'high':marginHr>=3?'mid':'low';
    const mhDisplay=marginHr>0?`<span class="td-margin-hr ${mhClass}">¬£${marginHr.toFixed(2)}/hr</span>`:`<span class="td-margin-hr mid">‚Äî</span>`;
    const costsHtml=d.cost>0?`<span class="td-erosion">-${fmtGBP(d.cost)}</span>`:`<span class="td-erosion zero">‚Äî</span>`;

    // Map WoW_Trend from CSV to badge
    const t=d.wowTrend.toLowerCase();
    let wowHtml;
    if(t.includes('improvement'))      wowHtml=`<span class="wow-badge improvement">‚Üó Improving</span>`;
    else if(t.includes('dropping'))    wowHtml=`<span class="wow-badge dropping">‚Üì Dropping</span>`;
    else if(t.includes('increasing'))  wowHtml=`<span class="wow-badge increasing">‚Üë Increasing Cost</span>`;
    else if(t.includes('reducing'))    wowHtml=`<span class="wow-badge improvement">‚Üò Reducing Cost</span>`;
    else                               wowHtml=`<span class="wow-badge neutral">‚Äî No Change</span>`;

    return `<tr>
      <td><div class="td-client-name">${esc(client)}</div><div class="td-owner">${esc(d.consultant)}</div></td>
      <td><span class="td-margin">${fmtGBP(d.margin)}</span></td>
      <td>${mhDisplay}</td>
      <td>${costsHtml}</td>
      <td>${wowHtml}</td>
    </tr>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// YIELD DESK PAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderYieldPage(rows){
  // Build per-client: hours (from Hours/Income rows), margin (Margin/Income), costs (Expense)
  const cMap={};
  rows.forEach(r=>{
    if(!cMap[r.client]) cMap[r.client]={consultant:r.consultant,hours:0,margin:0,cost:0};
    const c=cMap[r.client];
    if(isHoursRow(r)&&isIncomeRow(r))  c.hours+=r.value;
    else if(isCostRow(r))              c.cost+=Math.abs(r.value);
    else if(isIncomeRow(r)&&r.metric.toLowerCase().includes('margin')) c.margin+=r.value;
  });

  const clients=Object.entries(cMap).map(([name,d])=>{
    const net=d.margin-d.cost;
    return{name,consultant:d.consultant,hours:d.hours,margin:d.margin,cost:d.cost,net,
      marginPerHour:d.hours>0?net/d.hours:0};
  });

  const hasHours=clients.some(c=>c.hours>0);
  if(!hasHours||!clients.length){
    show('scatterEmpty',true); show('chartScatterWrap',false);
    document.getElementById('quadrantLegend').style.display='none';
    show('yieldRankEmpty',true); show('yieldRankList',false);
    ['kpiYieldAvg','kpiStars','kpiRiskCount','kpiDrains'].forEach(id=>document.getElementById(id).textContent='‚Äî');
    return;
  }

  const totalNet=clients.reduce((s,c)=>s+c.net,0);
  const totalHours=clients.reduce((s,c)=>s+c.hours,0);
  const avgYield=totalHours>0?totalNet/totalHours:0;
  const avgHours=clients.length?totalHours/clients.length:0;

  const getQ=c=>{
    if(c.marginPerHour>=avgYield&&c.hours>=avgHours) return 'star';
    if(c.marginPerHour<avgYield&&c.hours>=avgHours)  return 'risk';
    if(c.marginPerHour>=avgYield&&c.hours<avgHours)  return 'boutique';
    return 'drain';
  };
  const withQ=clients.map(c=>({...c,quadrant:getQ(c)}));

  const stars=withQ.filter(c=>c.quadrant==='star').length;
  const risks=withQ.filter(c=>c.quadrant==='risk').length;
  const drains=withQ.filter(c=>c.quadrant==='drain').length;

  document.getElementById('kpiYieldAvg').textContent = avgYield>0?`¬£${avgYield.toFixed(2)}`:'‚Äî';
  document.getElementById('kpiStars').textContent    = stars;
  document.getElementById('kpiRiskCount').textContent= risks;
  document.getElementById('kpiDrains').textContent   = drains;
  document.getElementById('yieldBadgeRisk').textContent = risks>0?`${risks} at risk`:'';

  // Scatter chart
  show('scatterEmpty',false); show('chartScatterWrap',true);
  document.getElementById('quadrantLegend').style.display='flex';
  if(scatterChart) scatterChart.destroy();

  scatterChart=new Chart(document.getElementById('chartScatter'),{
    type:'scatter',
    data:{datasets:[{
      label:'Clients',
      data:withQ.map(c=>({x:c.hours,y:c.marginPerHour,name:c.name,consultant:c.consultant,q:c.quadrant})),
      pointBackgroundColor:withQ.map(c=>Q_COLOR[c.quadrant]),
      pointRadius:7,pointHoverRadius:10,pointBorderWidth:2,pointBorderColor:'#fff',
    }]},
    options:{responsive:true,maintainAspectRatio:false,
      plugins:{legend:{display:false},
        tooltip:{...TT,callbacks:{
          title:items=>[items[0].raw.name],
          label:ctx=>[` Consultant: ${ctx.raw.consultant}`,` Volume: ${ctx.raw.x.toFixed(0)} hrs`,` Yield: ¬£${ctx.raw.y.toFixed(2)}/hr`,` Quadrant: ${ctx.raw.q.toUpperCase()}`]
        }}
      },
      scales:{
        x:{title:{display:true,text:'Volume (Hours)',color:'#9ba5bb',font:{family:CHART_FONT,size:10}},grid:{color:'#f0f2f5'},ticks:TICK('#9ba5bb'),border:{color:'#e8ecf1'}},
        y:{title:{display:true,text:'Yield (¬£/hr)',color:'#9ba5bb',font:{family:CHART_FONT,size:10}},grid:{color:'#f0f2f5'},ticks:{...TICK('#9ba5bb'),callback:v=>'¬£'+v},border:{color:'#e8ecf1'}}
      }
    }
  });

  // Draw reference lines after render
  const refPlugin={
    id:'refLines',
    afterDraw(chart){
      if(chart.canvas.id!=='chartScatter') return;
      const{ctx,scales:{x,y},chartArea}=chart;
      ctx.save(); ctx.setLineDash([5,5]); ctx.strokeStyle='#c8d0e0'; ctx.lineWidth=1;
      const ax=x.getPixelForValue(avgHours);
      ctx.beginPath(); ctx.moveTo(ax,chartArea.top); ctx.lineTo(ax,chartArea.bottom); ctx.stroke();
      const ay=y.getPixelForValue(avgYield);
      ctx.beginPath(); ctx.moveTo(chartArea.left,ay); ctx.lineTo(chartArea.right,ay); ctx.stroke();
      ctx.restore();
    }
  };
  if(!Chart.registry.plugins.get('refLines')) Chart.register(refPlugin);
  scatterChart.update();

  // Yield rank list
  show('yieldRankEmpty',false); show('yieldRankList',true);
  const sorted=[...withQ].sort((a,b)=>b.marginPerHour-a.marginPerHour);
  document.getElementById('yieldRankList').innerHTML=sorted.map(c=>`
    <div class="rank-item">
      <div style="display:flex;align-items:center;gap:9px;">
        <div class="rank-dot" style="background:${Q_COLOR[c.quadrant]}"></div>
        <div>
          <div class="rank-name">${esc(c.name)}</div>
          <div class="rank-meta">${esc(c.consultant)} ¬∑ ${c.quadrant.toUpperCase()}</div>
        </div>
      </div>
      <div>
        <div class="rank-val" style="color:${Q_COLOR[c.quadrant]}">${c.hours>0?'¬£'+c.marginPerHour.toFixed(2)+'/hr':'N/A'}</div>
        <div class="rank-sub">${c.hours.toFixed(0)} hrs ¬∑ net ${fmtGBP(c.net)}</div>
      </div>
    </div>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RISK ANALYSIS PAGE
// Uses WoW_Trend column + Cost_Type
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderRiskPage(rows){
  if(!rows.length){
    ['riskTotalFlagged','riskDropCount','riskHighCostCount','riskCleanCount'].forEach(id=>document.getElementById(id).textContent='‚Äî');
    document.getElementById('riskDropBadge').textContent='0';
    document.getElementById('riskCostBadge').textContent='0';
    document.getElementById('riskDropGrid').innerHTML='<div class="risk-empty">Upload a CSV to see risk analysis.</div>';
    document.getElementById('riskCostGrid').innerHTML='<div class="risk-empty">Upload a CSV to see risk analysis.</div>';
    return;
  }

  // Aggregate per client ‚Äî only using latest week for trend signals
  const cMap={};
  rows.forEach(r=>{
    if(!cMap[r.client]) cMap[r.client]={consultant:r.consultant,margin:0,cost:0,hours:0,wowTrends:[]};
    const c=cMap[r.client];
    if(isHoursRow(r))   c.hours+=Math.abs(r.value);
    else if(isCostRow(r)) c.cost+=Math.abs(r.value);
    else if(isIncomeRow(r)&&r.metric.toLowerCase().includes('margin')){
      c.margin+=r.value;
      if(r.wowTrend) c.wowTrends.push(r.wowTrend.toLowerCase());
    }
  });

  const clientList=Object.entries(cMap).map(([name,d])=>{
    const net=d.margin-d.cost;
    const costImpact=d.margin>0?(d.cost/d.margin)*100:0;
    // Dropping = any margin row has Dropping trend in WoW_Trend
    const isDropping=d.wowTrends.some(t=>t.includes('dropping'));
    return{name,consultant:d.consultant,margin:d.margin,cost:d.cost,net,hours:d.hours,costImpact,isDropping};
  });

  const dropping=clientList.filter(c=>c.isDropping);
  const highCost=clientList.filter(c=>c.costImpact>50&&c.margin>0);
  const flaggedSet=new Set([...dropping.map(c=>c.name),...highCost.map(c=>c.name)]);
  const clean=clientList.filter(c=>!flaggedSet.has(c.name)).length;

  document.getElementById('riskTotalFlagged').textContent = flaggedSet.size;
  document.getElementById('riskDropCount').textContent    = dropping.length;
  document.getElementById('riskHighCostCount').textContent= highCost.length;
  document.getElementById('riskCleanCount').textContent   = clean;
  document.getElementById('riskDropBadge').textContent    = dropping.length;
  document.getElementById('riskCostBadge').textContent    = highCost.length;

  const riskCard=(c,flags,isAmber=false)=>`
    <div class="risk-card ${isAmber?'amber-card':''}">
      <div class="risk-card-name">${esc(c.name)}</div>
      <div class="risk-card-owner">${esc(c.consultant)}</div>
      <div class="risk-flags">${flags}</div>
      <div class="risk-metrics-grid">
        <div><div class="rm-label">Gross Margin</div><div class="rm-val">${fmtGBP(c.margin)}</div></div>
        <div><div class="rm-label">Cost Impact</div><div class="rm-val" style="color:${c.costImpact>50?'var(--red)':'var(--text)'}">${c.costImpact.toFixed(1)}%</div></div>
        <div><div class="rm-label">Net Profit</div><div class="rm-val" style="color:${c.net<0?'var(--red)':'var(--profit-green)'}">${fmtGBP(c.net)}</div></div>
        <div><div class="rm-label">Total Cost</div><div class="rm-val">${fmtGBP(c.cost)}</div></div>
      </div>
    </div>`;

  document.getElementById('riskDropGrid').innerHTML=dropping.length
    ?dropping.sort((a,b)=>b.cost-a.cost).map(c=>riskCard(c,
        `<span class="rflag red">‚Üì Dropping</span>${c.costImpact>50?'<span class="rflag amber">High Cost</span>':''}`
      )).join('')
    :'<div class="risk-empty">‚úÖ No dropping trend accounts detected.</div>';

  document.getElementById('riskCostGrid').innerHTML=highCost.length
    ?highCost.sort((a,b)=>b.costImpact-a.costImpact).map(c=>riskCard(c,
        `<span class="rflag amber">${c.costImpact.toFixed(0)}% cost impact</span>${c.isDropping?'<span class="rflag red">Also Dropping</span>':''}`,true
      )).join('')
    :'<div class="risk-empty">‚úÖ No high cost impact accounts detected.</div>';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PAGE NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchPage(id,el){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(n=>n.classList.remove('active'));
  document.getElementById('page-'+id).classList.add('active');
  el.classList.add('active');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILITY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function show(id,visible){
  const el=document.getElementById(id); if(!el) return;
  el.classList.toggle('hidden',!visible);
}

// Init placeholders
['kpiGross','kpiTotalCost','kpiNet','kpiAnnual'].forEach(id=>document.getElementById(id).textContent='‚Äî');
</script>
</body>
</html>
